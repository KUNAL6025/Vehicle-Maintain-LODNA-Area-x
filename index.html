Index.html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEV GROUP NTST LODNA AREA-X</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .data-table th, .data-table td {
            border: 1px solid #e2e8f0;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background-color: #4f46e5;
            color: white;
        }
        .data-table tr:nth-child(even) {
            background-color: #f7fafc;
        }
        .data-table tr:hover {
            background-color: #ebf8ff;
        }
        .table-container {
            overflow-x: auto;
        }
        .logo-header {
            width: 80px;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            if (localStorage.getItem('isAuthenticated') !== 'true') {
                window.location.href = 'login.html';
            }
        });
    </script>
    
    <div class="container">
      <div class="flex flex-col md:flex-row justify-between items-center mb-6">
        <div class="flex items-center mb-4 md:mb-0">
          <img src="41720.jpg" alt="DEV GROUP DHANBAD Logo" class="logo-header mr-4">
          <h1 class="text-4xl font-extrabold text-indigo-700">DEV GROUP NTST LODNA AREA-X</h1>
        </div>
        <div class="flex items-center space-x-2">
          <button id="view-data-btn" class="btn-primary px-4 py-2 text-sm">View Data</button>
        </div>
      </div>
      <p class="text-center text-gray-600 mb-8">Enter daily shift details to keep a digital record, saved directly on your device.</p>
  
      <form id="log-form" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-group">
            <label for="operator">Operator Name</label>
            <input type="text" id="operator" placeholder="e.g., Kunal" required>
          </div>
          <div class="form-group">
            <label for="vehicle">Vehicle Number</label>
            <input type="text" id="vehicle" placeholder="e.g., DT-01" required>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-group">
            <label for="registration-no">Vehicle Registration No.</label>
            <input type="text" id="registration-no" placeholder="e.g., JH05 AT 1234">
          </div>
          <div class="form-group">
            <label for="chassis-no">Chassis Number</label>
            <input type="text" id="chassis-no" placeholder="e.g., ABC123XYZ456">
          </div>
        </div>
  
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-group">
            <label for="shift-start">Shift Start Time (AM/PM)</label>
            <input type="time" id="shift-start" required>
          </div>
          <div class="form-group">
            <label for="shift-end">Shift End Time (AM/PM)</label>
            <input type="time" id="shift-end" required>
          </div>
        </div>
        
        <div class="form-group hidden" id="total-hours-container">
            <label>Total Shift Duration</label>
            <input type="text" id="total-hours" class="font-bold text-lg text-indigo-700" readonly>
        </div>
  
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-group">
            <label for="opening-km">Opening KM</label>
            <input type="number" id="opening-km" placeholder="e.g., 12345" required>
          </div>
          <div class="form-group">
            <label for="closing-km">Closing KM</label>
            <input type="number" id="closing-km" placeholder="e.g., 12450" required>
          </div>
        </div>
  
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-group">
            <label for="opening-hmr">Opening HMR</label>
            <input type="number" id="opening-hmr" placeholder="e.g., 1200" required>
          </div>
          <div class="form-group">
            <label for="closing-hmr">Closing HMR</label>
            <input type="number" id="closing-hmr" placeholder="e.g., 1215" required>
          </div>
        </div>
  
        <div class="form-group">
          <label for="issues">Issues / Comments</label>
          <textarea id="issues" rows="3" placeholder="Any vehicle issues, notes, or special circumstances..."></textarea>
        </div>
  
        <div class="form-group">
          <label>Parts Required</label>
          <div class="table-container">
            <table id="parts-required-table" class="data-table mt-2">
              <thead>
                <tr>
                  <th class="w-10">S.No.</th>
                  <th class="w-48">Part Name</th>
                  <th class="w-32">Part No.</th>
                  <th class="w-16">QTY</th>
                  <th class="w-24">Parts Availability</th>
                  <th class="w-24">Order Date</th>
                  <th class="w-24">Parts Status</th>
                  <th class="w-48">Remarks</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
          <div class="flex justify-end mt-2">
              <button type="button" id="add-part-btn" class="btn-secondary px-4 py-2 text-sm">+ Add Part</button>
          </div>
        </div>
  
        <button type="submit" class="btn-primary w-full md:w-auto">Submit Log</button>
      </form>
  
      <hr class="my-8 border-t border-gray-200">
  
      <h2 id="recent-logs-heading" class="text-2xl font-bold text-center mb-6 text-gray-700">Recent Log Entries</h2>
      <div id="log-entries" class="space-y-4"></div>
  
      <div id="table-view" class="hidden mt-8">
        <h2 class="text-2xl font-bold text-center mb-6 text-gray-700">All Log Entries (Table View)</h2>
        <div class="flex items-center space-x-2 mb-4 justify-center">
            <input type="text" id="search-bar" placeholder="Search by Vehicle/Operator..." class="p-2 border border-gray-300 rounded-md w-48 md:w-64">
        </div>
        <div class="flex justify-center space-x-4 mb-4">
          <button id="export-excel-btn" class="btn-secondary">Export to Excel</button>
          <button id="export-pdf-btn" class="btn-secondary">Export to PDF</button>
          <button id="back-to-form-btn" class="btn-secondary">Back to Form</button>
        </div>
        <div class="table-container">
          <table id="data-table" class="data-table">
            <thead>
              <tr>
                <th>Date/Time</th>
                <th>Operator</th>
                <th>Vehicle No.</th>
                <th>Reg. No.</th>
                <th>Chassis No.</th>
                <th>Shift Start</th>
                <th>Shift End</th>
                <th>Total Hrs</th>
                <th>Opening KM</th>
                <th>Closing KM</th>
                <th>Total KM</th>
                <th>Opening HMR</th>
                <th>Closing HMR</th>
                <th>Total HMR</th>
              </tr>
            </thead>
            <tbody>
              </tbody>
          </table>
        </div>
      </div>
    </div>
  
    <div id="myModal" class="modal">
      <div class="modal-content rounded-lg shadow-xl">
        <h4 class="text-xl font-bold mb-4">Message</h4>
        <p id="modal-message" class="mb-6"></p>
        <button id="modal-ok-btn" class="btn-primary w-full md:w-auto">OK</button>
      </div>
    </div>
  
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const logForm = document.getElementById('log-form');
        const logEntriesContainer = document.getElementById('log-entries');
        const modal = document.getElementById('myModal');
        const modalMessage = document.getElementById('modal-message');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        const viewDataBtn = document.getElementById('view-data-btn');
        const tableView = document.getElementById('table-view');
        const dataTableBody = document.querySelector('#data-table tbody');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const backToFormBtn = document.getElementById('back-to-form-btn');
        const recentLogsHeading = document.getElementById('recent-logs-heading');
        const searchBar = document.getElementById('search-bar');
        const addPartBtn = document.getElementById('add-part-btn');
        const partsTableBody = document.querySelector('#parts-required-table tbody');
        const shiftStartInput = document.getElementById('shift-start');
        const shiftEndInput = document.getElementById('shift-end');
        const totalHoursInput = document.getElementById('total-hours');
        const totalHoursContainer = document.getElementById('total-hours-container');
  
        let partCounter = 1;
        let editingIndex = -1;
  
        function showModal(message) {
          modalMessage.textContent = message;
          modal.style.display = "flex";
        }
  
        modalOkBtn.onclick = () => { modal.style.display = "none"; };
        window.onclick = (e) => { if (e.target == modal) modal.style.display = "none"; };
  
        function getLogs() {
          const logs = localStorage.getItem('dumpTruckLogs');
          return logs ? JSON.parse(logs) : [];
        }
        function saveLogs(logs) {
          localStorage.setItem('dumpTruckLogs', JSON.stringify(logs));
        }
        function calculateTotalHours() {
            const start = shiftStartInput.value;
            const end = shiftEndInput.value;
            if (start && end) {
                const [startHour, startMinute] = start.split(':').map(Number);
                const [endHour, endMinute] = end.split(':').map(Number);
                const startDate = new Date();
                startDate.setHours(startHour, startMinute, 0);
                const endDate = new Date();
                endDate.setHours(endHour, endMinute, 0);
                
                if (endDate < startDate) {
                    endDate.setDate(endDate.getDate() + 1);
                }
                const diff = endDate - startDate;
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                totalHoursInput.value = `${hours} hours and ${minutes} minutes`;
                totalHoursContainer.classList.remove('hidden');
            } else {
                totalHoursContainer.classList.add('hidden');
            }
        }
        
        shiftStartInput.addEventListener('input', calculateTotalHours);
        shiftEndInput.addEventListener('input', calculateTotalHours);
  
        function renderLogs(logsToRender = null) {
          const logs = logsToRender || getLogs().sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          logEntriesContainer.innerHTML = '';
          if (logs.length === 0) {
            logEntriesContainer.innerHTML = '<p class="text-center text-gray-500">No log entries yet. Add one using the form above!</p>';
            return;
          }
  
          logs.forEach((log, index) => {
            const entry = document.createElement('div');
            entry.className = 'log-entry bg-white p-6 rounded-lg shadow-md mb-6';
            
            let partsTableHTML = '';
            if (log.partsRequired && log.partsRequired.length > 0) {
                partsTableHTML = `
                    <div class="mt-4">
                        <h4 class="font-bold text-gray-700">Parts Required:</h4>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th class="w-10">S.No.</th>
                                        <th class="w-48">Part Name</th>
                                        <th class="w-32">Part No.</th>
                                        <th class="w-16">QTY</th>
                                        <th class="w-24">Parts Availability</th>
                                        <th class="w-24">Order Date</th>
                                        <th class="w-24">Parts Status</th>
                                        <th class="w-48">Remarks</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${log.partsRequired.map((part, partIndex) => `
                                        <tr>
                                            <td>${partIndex + 1}.</td>
                                            <td>${part.name}</td>
                                            <td>${part.partNo || 'N/A'}</td>
                                            <td>${part.quantity}</td>
                                            <td>${part.availability}</td>
                                            <td>${part.orderDate || 'N/A'}</td>
                                            <td>${part.status}</td>
                                            <td>${part.remarks || 'N/A'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } else {
                partsTableHTML = `<p class="mt-2 text-sm text-gray-500">No parts required.</p>`;
            }
            entry.innerHTML = `
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-blue-700">${log.operator} - ${log.vehicle}</h3>
                <span class="text-xs text-gray-500">${new Date(log.timestamp).toLocaleString()}</span>
              </div>
              
              <div class="table-container mb-4">
                  <table class="data-table">
                      <thead>
                          <tr>
                              <th>Reg. No.</th>
                              <th>Chassis No.</th>
                              <th>Shift Start</th>
                              <th>Shift End</th>
                              <th>Total Hrs</th>
                              <th>Open KM</th>
                              <th>Close KM</th>
                              <th>Total KM</th>
                              <th>Open HMR</th>
                              <th>Close HMR</th>
                              <th>Total HMR</th>
                          </tr>
                      </thead>
                      <tbody>
                          <tr>
                              <td>${log.registrationNo || 'N/A'}</td>
                              <td>${log.chassisNo || 'N/A'}</td>
                              <td>${log.shiftStart}</td>
                              <td>${log.shiftEnd}</td>
                              <td>${log.totalHours}</td>
                              <td>${log.openingKm}</td>
                              <td>${log.closingKm}</td>
                              <td>${log.totalKm}</td>
                              <td>${log.openingHmr}</td>
                              <td>${log.closingHmr}</td>
                              <td>${log.totalHmr}</td>
                          </tr>
                      </tbody>
                  </table>
              </div>
              <div class="mt-4">
                  <h4 class="font-bold text-gray-700">Issues / Comments:</h4>
                  <p class="mt-2">${log.issues || 'No issues reported.'}</p>
              </div>
              ${partsTableHTML}
              <div class="flex space-x-2 mt-6">
                  <button class="btn-primary px-4 py-2 text-sm" data-index="${index}">Edit Log</button>
              </div>
            `;
            logEntriesContainer.appendChild(entry);
          });
  
          document.querySelectorAll('.btn-primary').forEach(button => {
              button.addEventListener('click', (e) => {
                  const index = e.target.dataset.index;
                  const logs = getLogs();
                  const logToEdit = logs[index];
                  const timeSinceEntry = (new Date() - new Date(logToEdit.timestamp)) / 1000 / 60;
  
                  if (timeSinceEntry > 30) {
                      showModal("Editing is only allowed for the first 30 minutes after submission.");
                      return;
                  }
                  
                  document.getElementById('operator').value = logToEdit.operator;
                  document.getElementById('vehicle').value = logToEdit.vehicle;
                  document.getElementById('registration-no').value = logToEdit.registrationNo;
                  document.getElementById('chassis-no').value = logToEdit.chassisNo;
                  document.getElementById('shift-start').value = logToEdit.shiftStart;
                  document.getElementById('shift-end').value = logToEdit.shiftEnd;
                  document.getElementById('opening-km').value = logToEdit.openingKm;
                  document.getElementById('closing-km').value = logToEdit.closingKm;
                  document.getElementById('opening-hmr').value = logToEdit.openingHmr;
                  document.getElementById('closing-hmr').value = logToEdit.closingHmr;
                  document.getElementById('issues').value = logToEdit.issues;
                  
                  partsTableBody.innerHTML = '';
                  partCounter = 1;
                  logToEdit.partsRequired.forEach(part => {
                      const newRow = partsTableBody.insertRow();
                      newRow.innerHTML = `
                          <td>${partCounter++}.</td>
                          <td><input type="text" class="part-name-input p-1 border rounded-md w-full" value="${part.name}" required></td>
                          <td><input type="text" class="part-partno-input p-1 border rounded-md w-full" value="${part.partNo || ''}"></td>
                          <td><input type="number" class="part-quantity-input p-1 border rounded-md w-full" value="${part.quantity}" min="1" required></td>
                          <td>
                              <select class="part-availability-input p-1 border rounded-md w-full">
                                  <option value="Available" ${part.availability === 'Available' ? 'selected' : ''}>Available</option>
                                  <option value="Not Available" ${part.availability === 'Not Available' ? 'selected' : ''}>Not Available</option>
                              </select>
                          </td>
                          <td><input type="date" class="part-orderdate-input p-1 border rounded-md w-full" value="${part.orderDate || ''}"></td>
                          <td>
                              <select class="part-status-input p-1 border rounded-md w-full">
                                  <option value="Pending" ${part.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                  <option value="Received" ${part.status === 'Received' ? 'selected' : ''}>Received</option>
                              </select>
                          </td>
                          <td><input type="text" class="part-remarks-input p-1 border rounded-md w-full" value="${part.remarks || ''}"></td>
                      `;
                  });
                  calculateTotalHours();
                  editingIndex = index;
                  showModal("You can now edit the log. Submit the form to save changes.");
              });
          });
        }
  
        function renderTable(logsToRender = null) {
          const logs = logsToRender || getLogs().sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp));
          dataTableBody.innerHTML = '';
          if (logs.length === 0) {
            dataTableBody.innerHTML = '<tr><td colspan="14" class="text-center text-gray-500">No log entries to display.</td></tr>';
            return;
          }
          logs.forEach(log => {
            const row = dataTableBody.insertRow();
            row.innerHTML = `
              <td>${new Date(log.timestamp).toLocaleString()}</td>
              <td>${log.operator}</td>
              <td>${log.vehicle}</td>
              <td>${log.registrationNo || ''}</td>
              <td>${log.chassisNo || ''}</td>
              <td>${log.shiftStart}</td>
              <td>${log.shiftEnd}</td>
              <td>${log.totalHours}</td>
              <td>${log.openingKm}</td>
              <td>${log.closingKm}</td>
              <td>${log.totalKm}</td>
              <td>${log.openingHmr}</td>
              <td>${log.closingHmr}</td>
              <td>${log.totalHmr}</td>
            `;
            
            const issuesRow = dataTableBody.insertRow();
            issuesRow.innerHTML = `<td colspan="14" class="bg-gray-50 text-gray-700"><strong>Issues:</strong> ${log.issues || ''}</td>`;
  
            if (log.partsRequired && log.partsRequired.length > 0) {
              const partsRow = dataTableBody.insertRow();
              partsRow.innerHTML = `<td colspan="14" class="p-0">
                  <div class="table-container">
                      <table class="data-table w-full">
                          <thead>
                              <tr>
                                  <th class="w-10">S.No.</th>
                                  <th class="w-48">Part Name</th>
                                  <th class="w-32">Part No.</th>
                                  <th class="w-16">QTY</th>
                                  <th class="w-24">Parts Availability</th>
                                  <th class="w-24">Order Date</th>
                                  <th class="w-24">Parts Status</th>
                                  <th class="w-48">Remarks</th>
                              </tr>
                          </thead>
                          <tbody>
                              ${log.partsRequired.map((part, partIndex) => `
                                  <tr>
                                      <td>${partIndex + 1}.</td>
                                      <td>${part.name}</td>
                                      <td>${part.partNo || 'N/A'}</td>
                                      <td>${part.quantity}</td>
                                      <td>${part.availability}</td>
                                      <td>${part.orderDate || 'N/A'}</td>
                                      <td>${part.status}</td>
                                      <td>${part.remarks || 'N/A'}</td>
                                  </tr>
                              `).join('')}
                          </tbody>
                      </table>
                  </div>
              </td>`;
            }
          });
        }
  
        addPartBtn.addEventListener('click', () => {
            const newRow = partsTableBody.insertRow();
            newRow.innerHTML = `
                <td>${partCounter++}.</td>
                <td><input type="text" class="part-name-input p-1 border rounded-md w-full" placeholder="Part Name" required></td>
                <td><input type="text" class="part-partno-input p-1 border rounded-md w-full" placeholder="Part No."></td>
                <td><input type="number" class="part-quantity-input p-1 border rounded-md w-full" value="1" min="1" required></td>
                <td>
                  <select class="part-availability-input p-1 border rounded-md w-full">
                    <option value="Available">Available</option>
                    <option value="Not Available" selected>Not Available</option>
                  </select>
                </td>
                <td><input type="date" class="part-orderdate-input p-1 border rounded-md w-full"></td>
                <td>
                  <select class="part-status-input p-1 border rounded-md w-full">
                    <option value="Pending" selected>Pending</option>
                    <option value="Received">Received</option>
                  </select>
                </td>
                <td><input type="text" class="part-remarks-input p-1 border rounded-md w-full" placeholder="Remarks"></td>
            `;
        });
        
        logForm.addEventListener('reset', () => {
            partsTableBody.innerHTML = '';
            partCounter = 1;
            editingIndex = -1;
            totalHoursContainer.classList.add('hidden');
        });
  
        viewDataBtn.addEventListener('click', () => {
          logForm.classList.add('hidden');
          recentLogsHeading.classList.add('hidden');
          logEntriesContainer.classList.add('hidden');
          tableView.classList.remove('hidden');
          viewDataBtn.classList.add('hidden');
          searchBar.value = '';
          renderTable();
        });
  
        backToFormBtn.addEventListener('click', () => {
          logForm.classList.remove('hidden');
          recentLogsHeading.classList.remove('hidden');
          logEntriesContainer.classList.remove('hidden');
          tableView.classList.add('hidden');
          viewDataBtn.classList.remove('hidden');
          searchBar.value = '';
          renderLogs();
        });
  
        searchBar.addEventListener('keyup', () => {
          const query = searchBar.value.toLowerCase();
          const logs = getLogs();
          const filteredLogs = logs.filter(log =>
            log.operator.toLowerCase().includes(query) ||
            log.vehicle.toLowerCase().includes(query) ||
            (log.registrationNo && log.registrationNo.toLowerCase().includes(query)) ||
            (log.chassisNo && log.chassisNo.toLowerCase().includes(query))
          );
          renderTable(filteredLogs);
        });
  
        exportExcelBtn.addEventListener('click', () => {
          const logs = getLogs().sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp));
          if (logs.length === 0) {
            showModal("No data to export to Excel.");
            return;
          }
          let csvContent = "data:text/csv;charset=utf-8,";
          csvContent += "Date/Time,Operator,Vehicle,Registration No,Chassis No,Shift Start,Shift End,Total Hrs,Opening KM,Closing KM,Total KM,Opening HMR,Closing HMR,Total HMR,Issues,Parts Required\n";
          logs.forEach(log => {
            const partsText = log.partsRequired.map(part => `${part.name} (Part No: ${part.partNo || 'N/A'}), Qty: ${part.quantity}, Status: ${part.status}`).join('; ');
            let row = [
              `"${new Date(log.timestamp).toLocaleString()}"`,
              `"${log.operator}"`,
              `"${log.vehicle}"`,
              `"${log.registrationNo || ''}"`,
              `"${log.chassisNo || ''}"`,
              `"${log.shiftStart}"`,
              `"${log.shiftEnd}"`,
              `"${log.totalHours}"`,
              log.openingKm,
              log.closingKm,
              log.totalKm,
              log.openingHmr,
              log.closingHmr,
              log.totalHmr,
              `"${log.issues ? log.issues.replace(/"/g, '""') : ''}"`,
              `"${partsText.replace(/"/g, '""')}"`
            ];
            csvContent += row.join(",") + "\n";
          });
          const encodedUri = encodeURI(csvContent);
          const link = document.createElement("a");
          link.setAttribute("href", encodedUri);
          link.setAttribute("download", "dump_truck_logs.csv");
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          showModal("Data exported to Excel (CSV) successfully!");
        });
  
        exportPdfBtn.addEventListener('click', () => {
          const logs = getLogs().sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp));
          if (logs.length === 0) {
            showModal("No data to export to PDF.");
            return;
          }
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF('l');
          const headers = ["Date/Time", "Operator", "Vehicle No.", "Reg. No.", "Chassis No.", "Shift Start", "Shift End", "Total Hrs", "Open KM", "Close KM", "Total KM", "Open HMR", "Close HMR", "Total HMR", "Issues", "Parts Required"];
          const data = logs.map(log => {
            const partsText = log.partsRequired.map(part => `Part: ${part.name} (No: ${part.partNo || 'N/A'}), Qty: ${part.quantity}, Status: ${part.status}`).join('; ');
            return [
              new Date(log.timestamp).toLocaleString(), log.operator, log.vehicle, log.registrationNo || '', log.chassisNo || '',
              log.shiftStart, log.shiftEnd, log.totalHours, log.openingKm, log.closingKm, log.totalKm, log.openingHmr, log.closingHmr, log.totalHmr,
              log.issues || '', partsText || ''
            ];
          });
          doc.text("DEV GROUP NTST LODNA AREA-X - Log Entries", 14, 15);
          doc.autoTable({
            startY: 20, head: [headers], body: data, theme: 'grid', styles: { fontSize: 5, cellPadding: 0.5, overflow: 'linebreak' },
            headStyles: { fillColor: [76, 81, 191], textColor: [255, 255, 255] },
            margin: { top: 10, left: 5, right: 5, bottom: 10 },
            didDrawPage: function(data) {
              var str = "Page " + doc.internal.getNumberOfPages();
              doc.setFontSize(8);
              doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
            }
          });
          doc.save("dump_truck_logs.pdf");
          showModal("Data exported to PDF successfully!");
        });
  
        logForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const operator = document.getElementById('operator').value;
          const vehicle = document.getElementById('vehicle').value;
          const registrationNo = document.getElementById('registration-no').value;
          const chassisNo = document.getElementById('chassis-no').value;
          const shiftStart = document.getElementById('shift-start').value;
          const shiftEnd = document.getElementById('shift-end').value;
          const openingKm = parseFloat(document.getElementById('opening-km').value);
          const closingKm = parseFloat(document.getElementById('closing-km').value);
          const openingHmr = parseFloat(document.getElementById('opening-hmr').value);
          const closingHmr = parseFloat(document.getElementById('closing-hmr').value);
          const issues = document.getElementById('issues').value;
          const totalHours = totalHoursInput.value;
          
          const partsRequired = [];
          const partRows = partsTableBody.querySelectorAll('tr');
          partRows.forEach(row => {
              const partName = row.querySelector('.part-name-input').value;
              const partNo = row.querySelector('.part-partno-input').value;
              const quantity = parseInt(row.querySelector('.part-quantity-input').value, 10);
              const availability = row.querySelector('.part-availability-input').value;
              const orderDate = row.querySelector('.part-orderdate-input').value;
              const status = row.querySelector('.part-status-input').value;
              const remarks = row.querySelector('.part-remarks-input').value;
              if (partName && quantity) {
                  partsRequired.push({ name: partName, partNo, quantity, availability, orderDate, status, remarks });
              }
          });
  
          if (!operator || !vehicle || !shiftStart || !shiftEnd || isNaN(openingKm) || isNaN(closingKm) || isNaN(openingHmr) || isNaN(closingHmr)) {
            showModal("Please fill out all required fields.");
            return;
          }
  
          if (closingKm < openingKm) {
              showModal("Closing KM cannot be less than Opening KM.");
              return;
          }
          if (closingHmr < openingHmr) {
              showModal("Closing HMR cannot be less than Opening HMR.");
              return;
          }
  
          const totalKm = closingKm - openingKm;
          const totalHmr = closingHmr - openingHmr;
  
          let logs = getLogs();
          const logData = { operator, vehicle, registrationNo, chassisNo, shiftStart, shiftEnd, totalHours, openingKm, closingKm, totalKm, openingHmr, closingHmr, totalHmr, issues, partsRequired, timestamp: new Date().toISOString() };
  
          if (editingIndex !== -1) {
              logs[editingIndex] = { ...logData, timestamp: logs[editingIndex].timestamp };
              editingIndex = -1;
          } else {
              logs.push(logData);
          }
          
          saveLogs(logs);
          logForm.reset();
          renderLogs();
          showModal("Log entry saved successfully!");
        });
  
        renderLogs();
      });
    </script>
</body>
</html>
